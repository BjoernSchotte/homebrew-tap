name: Update Formula

on:
  workflow_dispatch:
    inputs:
      formula:
        description: 'Formula name (e.g., atlcli)'
        required: true
        default: 'atlcli'
      tag:
        description: 'Release tag (e.g., v0.2.0)'
        required: true
      repository:
        description: 'Source repository (e.g., bjoernschotte/atlcli)'
        required: true
        default: 'BjoernSchotte/atlcli'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update formula
        run: |
          FORMULA="${{ inputs.formula }}"
          TAG="${{ inputs.tag }}"
          REPO="${{ inputs.repository }}"
          VERSION="${TAG#v}"

          echo "Updating $FORMULA to $VERSION from $REPO"

          # Download and calculate SHA256 for each platform
          declare -A SHAS

          for platform in darwin-arm64 darwin-x64 linux-arm64 linux-x64; do
            URL="https://github.com/${REPO}/releases/download/${TAG}/${FORMULA}-${platform}.tar.gz"
            echo "Downloading $URL..."

            if curl -fsSL -o "/tmp/${platform}.tar.gz" "$URL"; then
              SHA=$(sha256sum "/tmp/${platform}.tar.gz" | awk '{print $1}')
              SHAS[$platform]=$SHA
              echo "  SHA256: $SHA"
            else
              echo "  Failed to download $platform"
              exit 1
            fi
          done

          # Update the formula file
          FORMULA_FILE="Formula/${FORMULA}.rb"

          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$FORMULA_FILE"

          # Update SHA256 hashes - handle both placeholders and real hashes
          # For darwin-arm64
          sed -i "/darwin-arm64/{n;s/sha256 \"[^\"]*\"/sha256 \"${SHAS[darwin-arm64]}\"/}" "$FORMULA_FILE"
          # For darwin-x64
          sed -i "/darwin-x64/{n;s/sha256 \"[^\"]*\"/sha256 \"${SHAS[darwin-x64]}\"/}" "$FORMULA_FILE"
          # For linux-arm64
          sed -i "/linux-arm64/{n;s/sha256 \"[^\"]*\"/sha256 \"${SHAS[linux-arm64]}\"/}" "$FORMULA_FILE"
          # For linux-x64
          sed -i "/linux-x64/{n;s/sha256 \"[^\"]*\"/sha256 \"${SHAS[linux-x64]}\"/}" "$FORMULA_FILE"

          echo "Updated $FORMULA_FILE:"
          cat "$FORMULA_FILE"

      - name: Commit and push
        run: |
          git add Formula/
          git commit -m "Update ${{ inputs.formula }} to ${{ inputs.tag }}"
          git push
